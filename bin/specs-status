#!/usr/bin/env python3

import os
import sys
import subprocess
import shutil

def get_project_root():
    """Get the project root directory (parent of bin/)."""
    script_dir = os.path.dirname(os.path.abspath(__file__))
    return os.path.dirname(script_dir)

def get_open_prs(search_term):
    """Get open PRs related to the spec using gh CLI."""
    if not shutil.which("gh"):
        return None

    # Search for the spec name which often matches branch names or titles
    cmd = [
        "gh", "pr", "list",
        "--state", "open",
        "--search", search_term,
        "--json", "number,title,url,author,headRefName,updatedAt",
        "--template", "{{range .}}- #{{.number}} {{.title}} ({{.headRefName}}) - {{.author.login}}\n  {{.url}}\n{{end}}"
    ]
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        return result.stdout
    except subprocess.CalledProcessError:
        return None

def main():
    if len(sys.argv) < 2:
        print("Usage: bin/specs-status <spec-name>")
        sys.exit(1)

    spec_input = sys.argv[1]
    project_root = get_project_root()
    
    # Resolve spec path
    # Handle inputs like "specs/007-agents" or "007-agents"
    if spec_input.startswith("specs/"):
        spec_name = spec_input[len("specs/"):]
    elif spec_input.startswith("spec/"):
        spec_name = spec_input[len("spec/"):]
    else:
        spec_name = spec_input

    # Remove trailing slashes
    spec_name = spec_name.rstrip('/')
    
    # Check if it exists in specs/
    spec_dir = os.path.join("specs", spec_name)
    full_spec_path = os.path.join(project_root, spec_dir)
    
    if not os.path.exists(full_spec_path):
        # Try to find it if it's just a partial match or maybe inside a subdir?
        # For now, strict matching with what was provided, assuming it's a top-level spec dir
        print(f"Warning: Spec directory not found at {spec_dir}", file=sys.stderr)
        return

    print(f"Recent commits for {spec_dir}:")
    print("-" * 40)

    # Git command to show recent history for this path across all branches
    # We use --all to see main and the feature branch (and any others)
    cmd = [
        "git",
        "log",
        "-n", "10",
        "--graph",
        "--abbrev-commit",
        "--decorate",
        "--date=relative",
        "--format=format:%C(bold blue)%h%C(reset) - %C(bold green)(%ar)%C(reset) %C(white)%s%C(reset) %C(dim white)- %an%C(reset)%C(auto)%d%C(reset)",
        "--all",
        "--",
        spec_dir
    ]

    try:
        subprocess.run(cmd, check=True, cwd=project_root)
    except subprocess.CalledProcessError as e:
        print(f"Error running git log: {e}", file=sys.stderr)

    # Check for Open PRs
    print(f"\nOpen Pull Requests matching '{spec_name}':")
    print("-" * 40)
    prs = get_open_prs(spec_name)
    if prs and prs.strip():
        print(prs)
    elif prs is None:
        if not shutil.which("gh"):
             print("GitHub CLI (gh) not found, skipping PR check.")
        else:
             print("Error fetching PRs.")
    else:
        print("No open PRs found.")

if __name__ == "__main__":
    main()