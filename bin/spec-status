#!/usr/bin/env python3

import os
import sys
import subprocess
import shutil

def get_project_root():
    """Get the project root directory (parent of bin/)."""
    script_dir = os.path.dirname(os.path.abspath(__file__))
    return os.path.dirname(script_dir)

def get_open_prs(search_term):
    """Get open PRs related to the spec using gh CLI."""
    if not shutil.which("gh"):
        return None

    # Search for the spec name which often matches branch names or titles
    # Template outputs a markdown list item
    cmd = [
        "gh", "pr", "list",
        "--state", "open",
        "--search", search_term,
        "--json", "number,title,url,author,headRefName,updatedAt",
        "--template", "{{range .}}- [{{.title}}]({{.url}}) (#{{.number}}) by @{{.author.login}} ({{.headRefName}})\n{{end}}"
    ]
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        return result.stdout
    except subprocess.CalledProcessError:
        return None

def main():
    if len(sys.argv) < 2:
        print("Usage: bin/spec-status <spec-name>")
        sys.exit(1)

    spec_input = sys.argv[1]
    project_root = get_project_root()
    
    # Resolve spec path
    # Handle inputs like "specs/007-agents" or "007-agents"
    if spec_input.startswith("specs/"):
        spec_name = spec_input[len("specs/"):]
    elif spec_input.startswith("spec/"):
        spec_name = spec_input[len("spec/"):]
    else:
        spec_name = spec_input

    # Remove trailing slashes
    spec_name = spec_name.rstrip('/')
    
    # Check if it exists in specs/
    spec_dir = os.path.join("specs", spec_name)
    full_spec_path = os.path.join(project_root, spec_dir)
    
    if not os.path.exists(full_spec_path):
        print(f"Warning: Spec directory not found at {spec_dir}", file=sys.stderr)
        return

    print(f"### Recent Commits for `{spec_dir}`")
    print("")

    # Git command to show recent history for this path across all branches
    # Formatted as a markdown list
    cmd = [
        "git",
        "--no-pager",
        "log",
        "-n", "10",
        "--abbrev-commit",
        "--date=relative",
        # Format: - `hash` (date) message - **author**
        "--format=format:- `%h` (%ar) %s - **%an**",
        "--all",
        "--",
        spec_dir
    ]

    try:
        subprocess.run(cmd, check=True, cwd=project_root)
    except subprocess.CalledProcessError as e:
        print(f"Error running git log: {e}", file=sys.stderr)

    # Check for Open PRs
    print(f"\n\n### Open Pull Requests matching `{spec_name}`")
    print("")
    prs = get_open_prs(spec_name)
    if prs and prs.strip():
        print(prs)
    elif prs is None:
        if not shutil.which("gh"):
             print("_GitHub CLI (gh) not found, skipping PR check._")
        else:
             print("_Error fetching PRs._")
    else:
        print("_No open PRs found._")

if __name__ == "__main__":
    main()
