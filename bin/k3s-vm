#!/usr/bin/env python3
"""
K3s VM Management Script (NixOS-native)

Creates a local K3s development VM using NixOS configuration and QEMU.
Zero external dependencies beyond Nix.
"""

import argparse
import os
import signal
import subprocess
import sys
import time
from pathlib import Path

# ============================================================================
# Configuration
# ============================================================================

SCRIPT_DIR = Path(__file__).parent.resolve()
PROJECT_ROOT = SCRIPT_DIR.parent

# Paths
CONFIG_DIR = PROJECT_ROOT / ".k3s-vm"
VM_DIR = CONFIG_DIR / "vm"
KUBECONFIG_DIR = PROJECT_ROOT / "web" / ".kube"
KUBECONFIG_FILE = KUBECONFIG_DIR / "config"
PID_FILE = CONFIG_DIR / "vm.pid"

# VM settings
DEFAULT_VM_MEMORY = 4096
DEFAULT_VM_CORES = 2

# NixOS configuration template for K3s VM
NIXOS_CONFIG_TEMPLATE = '''
{{ config, pkgs, lib, ... }}:
{{
  # Boot configuration for VM
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  # Networking
  networking.hostName = "k3s-vm";
  networking.firewall.enable = false;

  # Enable SSH
  services.openssh = {{
    enable = true;
    settings.PermitRootLogin = "yes";
  }};

  # K3s service
  services.k3s = {{
    enable = true;
    role = "server";
    extraFlags = toString [
      "--disable=traefik"
      "--write-kubeconfig-mode=644"
    ];
  }};

  # Root user with SSH key
  users.users.root = {{
    openssh.authorizedKeys.keys = [
      "{ssh_public_key}"
    ];
  }};

  # Useful packages
  environment.systemPackages = with pkgs; [
    kubectl
    k9s
    vim
    curl
    htop
  ];

  # Auto-login for console access (optional, for debugging)
  services.getty.autologinUser = "root";

  # VM-specific settings
  virtualisation.vmVariant = {{
    virtualisation.memorySize = {memory};
    virtualisation.cores = {cores};
    virtualisation.graphics = false;

    # Forward ports for K3s API and SSH
    virtualisation.forwardPorts = [
      {{ from = "host"; host.port = 6443; guest.port = 6443; }}
      {{ from = "host"; host.port = 2222; guest.port = 22; }}
    ];
  }};

  system.stateVersion = "24.05";
}}
'''


def run(cmd: list[str], check: bool = True, capture: bool = False, **kwargs) -> subprocess.CompletedProcess:
    """Run a command and return result."""
    if capture:
        kwargs.setdefault("stdout", subprocess.PIPE)
        kwargs.setdefault("stderr", subprocess.PIPE)
        kwargs.setdefault("text", True)
    return subprocess.run(cmd, check=check, **kwargs)


def error(msg: str) -> None:
    """Print error and exit."""
    print(f"ERROR: {msg}", file=sys.stderr)
    sys.exit(1)


def info(msg: str) -> None:
    """Print info message."""
    print(f"  {msg}")


def get_ssh_public_key() -> str:
    """Get or generate SSH public key."""
    ssh_key = Path.home() / ".ssh" / "id_rsa"
    ssh_pub = ssh_key.with_suffix(".pub")

    if not ssh_pub.exists():
        if not ssh_key.parent.exists():
            ssh_key.parent.mkdir(mode=0o700)
        print("Generating SSH key...")
        run(["ssh-keygen", "-t", "rsa", "-b", "4096", "-N", "", "-f", str(ssh_key)])

    return ssh_pub.read_text().strip()


def is_vm_running() -> bool:
    """Check if VM process is running."""
    if not PID_FILE.exists():
        return False

    try:
        pid = int(PID_FILE.read_text().strip())
        os.kill(pid, 0)  # Check if process exists
        return True
    except (ProcessLookupError, ValueError):
        PID_FILE.unlink(missing_ok=True)
        return False


def get_vm_pid() -> int | None:
    """Get VM process PID."""
    if not PID_FILE.exists():
        return None
    try:
        return int(PID_FILE.read_text().strip())
    except ValueError:
        return None


def wait_for_ssh(timeout: int = 120) -> bool:
    """Wait for SSH to become available."""
    start = time.time()
    while time.time() - start < timeout:
        try:
            result = run(
                ["ssh", "-o", "StrictHostKeyChecking=no", "-o", "ConnectTimeout=5",
                 "-o", "BatchMode=yes", "-p", "2222", "root@localhost", "true"],
                capture=True, check=False
            )
            if result.returncode == 0:
                return True
        except Exception:
            pass
        time.sleep(2)
    return False


def wait_for_k3s(timeout: int = 120) -> bool:
    """Wait for K3s API to become available."""
    start = time.time()
    while time.time() - start < timeout:
        try:
            result = run(
                ["ssh", "-o", "StrictHostKeyChecking=no", "-p", "2222",
                 "root@localhost", "kubectl get nodes"],
                capture=True, check=False
            )
            if result.returncode == 0 and "Ready" in result.stdout:
                return True
        except Exception:
            pass
        time.sleep(3)
    return False


def extract_kubeconfig() -> bool:
    """Extract kubeconfig from VM."""
    try:
        result = run(
            ["ssh", "-o", "StrictHostKeyChecking=no", "-p", "2222",
             "root@localhost", "cat /etc/rancher/k3s/k3s.yaml"],
            capture=True
        )

        # Replace localhost with 127.0.0.1:6443 (forwarded port)
        kubeconfig = result.stdout.replace("127.0.0.1:6443", "127.0.0.1:6443")
        kubeconfig = kubeconfig.replace("https://127.0.0.1", "https://127.0.0.1")

        KUBECONFIG_DIR.mkdir(parents=True, exist_ok=True)
        KUBECONFIG_FILE.write_text(kubeconfig)
        return True
    except subprocess.CalledProcessError:
        return False


# ============================================================================
# Commands
# ============================================================================

def cmd_setup(args: argparse.Namespace) -> None:
    """Build and start the K3s VM."""
    memory = args.memory or DEFAULT_VM_MEMORY
    cores = args.cpus or DEFAULT_VM_CORES

    if is_vm_running():
        error("VM is already running. Use 'bin/k3s-vm stop' first.")

    print(f"Setting up K3s VM (NixOS)")
    print(f"  Memory: {memory}MB, Cores: {cores}")
    print()

    # Create config directory
    CONFIG_DIR.mkdir(parents=True, exist_ok=True)
    VM_DIR.mkdir(parents=True, exist_ok=True)

    # Get SSH key
    ssh_key = get_ssh_public_key()
    info("SSH key ready")

    # Write NixOS configuration
    config_file = VM_DIR / "configuration.nix"
    config_content = NIXOS_CONFIG_TEMPLATE.format(
        ssh_public_key=ssh_key,
        memory=memory,
        cores=cores
    )
    config_file.write_text(config_content)
    info("NixOS configuration written")

    # Build the VM
    print("  Building NixOS VM (this may take a few minutes on first run)...")
    try:
        run(
            ["nix-build", "<nixpkgs/nixos>", "-A", "vm",
             "-I", "nixpkgs=channel:nixos-24.05",
             "-I", f"nixos-config={config_file}",
             "-o", str(VM_DIR / "result")],
            cwd=VM_DIR
        )
    except subprocess.CalledProcessError:
        error("Failed to build NixOS VM")

    info("VM built successfully")

    # Remove old disk image to ensure fresh state
    disk_image = VM_DIR / "nixos.qcow2"
    disk_image.unlink(missing_ok=True)

    # Start the VM in background
    print("  Starting VM...")
    # Find the run script (name is based on hostname: run-{hostname}-vm)
    bin_dir = VM_DIR / "result" / "bin"
    vm_scripts = list(bin_dir.glob("run-*-vm"))
    if not vm_scripts:
        error("VM run script not found in result/bin/")
    vm_script = vm_scripts[0]

    env = os.environ.copy()
    env["QEMU_KERNEL_PARAMS"] = "console=ttyS0"

    # Start VM process
    proc = subprocess.Popen(
        [str(vm_script), "-nographic"],
        cwd=VM_DIR,
        env=env,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        start_new_session=True
    )

    PID_FILE.write_text(str(proc.pid))
    info(f"VM started (PID: {proc.pid})")

    # Wait for SSH
    print("  Waiting for VM to boot...")
    if not wait_for_ssh(180):
        error("Timeout waiting for SSH. Check VM logs.")
    info("SSH available")

    # Wait for K3s
    print("  Waiting for K3s to be ready...")
    if not wait_for_k3s(180):
        error("Timeout waiting for K3s. Check VM logs.")
    info("K3s ready")

    # Extract kubeconfig
    print("  Extracting kubeconfig...")
    if not extract_kubeconfig():
        error("Failed to extract kubeconfig")
    info(f"Kubeconfig saved to {KUBECONFIG_FILE}")

    print()
    print("=" * 50)
    print("K3s VM setup complete!")
    print()
    print(f"  SSH:        ssh -p 2222 root@localhost")
    print(f"  K3s API:    https://127.0.0.1:6443")
    print(f"  Kubeconfig: {KUBECONFIG_FILE}")
    print()
    print("Try: bin/kubectl get nodes")


def cmd_start(args: argparse.Namespace) -> None:
    """Start the VM."""
    if is_vm_running():
        error("VM is already running.")

    bin_dir = VM_DIR / "result" / "bin"
    if not bin_dir.exists():
        error("VM not built. Run 'bin/k3s-vm setup' first.")

    vm_scripts = list(bin_dir.glob("run-*-vm"))
    if not vm_scripts:
        error("VM run script not found. Run 'bin/k3s-vm setup' first.")
    vm_script = vm_scripts[0]

    print("Starting VM...")

    env = os.environ.copy()
    env["QEMU_KERNEL_PARAMS"] = "console=ttyS0"

    proc = subprocess.Popen(
        [str(vm_script), "-nographic"],
        cwd=VM_DIR,
        env=env,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        start_new_session=True
    )

    PID_FILE.write_text(str(proc.pid))
    info(f"VM started (PID: {proc.pid})")

    print("  Waiting for SSH...")
    if not wait_for_ssh(120):
        error("Timeout waiting for SSH")
    info("SSH available")

    print("  Waiting for K3s...")
    if not wait_for_k3s(60):
        print("  Warning: K3s not ready yet, may need more time")
    else:
        info("K3s ready")

    print()
    print("VM started. Try: bin/kubectl get nodes")


def cmd_stop(args: argparse.Namespace) -> None:
    """Stop the VM."""
    if not is_vm_running():
        error("VM is not running.")

    pid = get_vm_pid()
    if pid:
        print(f"Stopping VM (PID: {pid})...")
        try:
            os.kill(pid, signal.SIGTERM)
            # Wait for process to terminate
            for _ in range(30):
                try:
                    os.kill(pid, 0)
                    time.sleep(1)
                except ProcessLookupError:
                    break
            else:
                # Force kill if still running
                os.kill(pid, signal.SIGKILL)
        except ProcessLookupError:
            pass

        PID_FILE.unlink(missing_ok=True)
        print("VM stopped.")
    else:
        error("Could not find VM process.")


def cmd_status(args: argparse.Namespace) -> None:
    """Show VM status."""
    print("K3s VM Status (NixOS)")
    print()

    if is_vm_running():
        pid = get_vm_pid()
        print(f"  State: running (PID: {pid})")
        print(f"  SSH:   ssh -p 2222 root@localhost")
        print(f"  API:   https://127.0.0.1:6443")

        # Check K3s status
        try:
            result = run(
                ["ssh", "-o", "StrictHostKeyChecking=no", "-o", "ConnectTimeout=5",
                 "-p", "2222", "root@localhost", "kubectl get nodes --no-headers"],
                capture=True, check=False
            )
            if result.returncode == 0:
                nodes = len([l for l in result.stdout.strip().split("\n") if l])
                print(f"  Nodes: {nodes} ready")
        except Exception:
            print("  K3s:   checking...")

        if KUBECONFIG_FILE.exists():
            print(f"\n  Kubeconfig: {KUBECONFIG_FILE}")
    else:
        bin_dir = VM_DIR / "result" / "bin"
        if bin_dir.exists() and list(bin_dir.glob("run-*-vm")):
            print("  State: stopped (VM built)")
            print("\n  Run 'bin/k3s-vm start' to start")
        else:
            print("  State: not configured")
            print("\n  Run 'bin/k3s-vm setup' to create VM")


def cmd_reset(args: argparse.Namespace) -> None:
    """Reset/destroy the VM."""
    if not args.yes:
        print("WARNING: This will delete the VM and all data.")
        response = input("Are you sure? (yes/no): ")
        if response.lower() != "yes":
            print("Cancelled.")
            return

    print("Resetting VM...")

    # Stop if running
    if is_vm_running():
        info("Stopping VM...")
        pid = get_vm_pid()
        if pid:
            try:
                os.kill(pid, signal.SIGKILL)
            except ProcessLookupError:
                pass
        PID_FILE.unlink(missing_ok=True)

    # Remove VM directory contents
    if VM_DIR.exists():
        info("Removing VM files...")
        import shutil
        shutil.rmtree(VM_DIR, ignore_errors=True)

    # Remove kubeconfig
    if KUBECONFIG_FILE.exists():
        info("Removing kubeconfig...")
        KUBECONFIG_FILE.unlink()

    print()
    print("Reset complete.")
    print("Run 'bin/k3s-vm setup' to create a new VM.")


def cmd_ssh(args: argparse.Namespace) -> None:
    """SSH into the VM."""
    if not is_vm_running():
        error("VM is not running. Start it with 'bin/k3s-vm start'")

    os.execlp("ssh", "ssh", "-o", "StrictHostKeyChecking=no", "-p", "2222", "root@localhost")


# ============================================================================
# Main
# ============================================================================

def main() -> None:
    parser = argparse.ArgumentParser(
        description="K3s VM Management (NixOS-native)",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  bin/k3s-vm setup              Build and start K3s VM
  bin/k3s-vm start              Start existing VM
  bin/k3s-vm stop               Stop VM
  bin/k3s-vm status             Check VM status
  bin/k3s-vm ssh                SSH into VM
  bin/k3s-vm reset              Destroy VM
""",
    )
    parser.add_argument("--version", action="version", version="k3s-vm 2.0.0 (NixOS)")

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # setup
    p_setup = subparsers.add_parser("setup", help="Build and start K3s VM")
    p_setup.add_argument("--cpus", type=int, help=f"CPU cores (default: {DEFAULT_VM_CORES})")
    p_setup.add_argument("--memory", type=int, help=f"Memory in MB (default: {DEFAULT_VM_MEMORY})")

    # start
    subparsers.add_parser("start", help="Start existing VM")

    # stop
    subparsers.add_parser("stop", help="Stop VM")

    # status
    subparsers.add_parser("status", help="Show VM status")

    # reset
    p_reset = subparsers.add_parser("reset", help="Destroy VM")
    p_reset.add_argument("--yes", "-y", action="store_true", help="Skip confirmation")

    # ssh
    subparsers.add_parser("ssh", help="SSH into VM")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    commands = {
        "setup": cmd_setup,
        "start": cmd_start,
        "stop": cmd_stop,
        "status": cmd_status,
        "reset": cmd_reset,
        "ssh": cmd_ssh,
    }

    commands[args.command](args)


if __name__ == "__main__":
    main()
