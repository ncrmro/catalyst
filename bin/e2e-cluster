#!/usr/bin/env bash
#
# E2E Cluster Management Script
#
# Replicates the CI E2E job locally using K3s VM + Helm chart.
# This is the local equivalent of .github/workflows/web.test.yml (e2e job).
#
# The Helm chart is the single source of truth for deployment.
# bin/k3s-vm provides a bare K3s cluster; this script deploys via Helm on top.
#
# Usage:
#   bin/e2e-cluster up [--skip-build]  # Start VM, build images, helm install, seed, port-forward
#   bin/e2e-cluster down               # Helm uninstall + kill port-forward (VM preserved)
#   bin/e2e-cluster test [-- args]     # Run Playwright E2E tests
#   bin/e2e-cluster status             # Show cluster/pod status
#   bin/e2e-cluster logs [web|operator] # Tail pod logs

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
NAMESPACE="catalyst-system"
KUBECONFIG_FILE="$PROJECT_ROOT/web/.kube/config"
VALUES_FILE="$PROJECT_ROOT/charts/catalyst/e2e-values.yaml"
PF_PID_FILE="$PROJECT_ROOT/.k3s-vm/e2e-port-forward.pid"
HOST_PORT=8080

OPERATOR_IMAGE="ghcr.io/ncrmro/catalyst/operator:latest"
WEB_IMAGE="ghcr.io/ncrmro/catalyst/web:latest"

SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2666"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info()  { echo -e "${BLUE}[info]${NC}  $*"; }
ok()    { echo -e "${GREEN}[ok]${NC}    $*"; }
warn()  { echo -e "${YELLOW}[warn]${NC}  $*"; }
error() { echo -e "${RED}[error]${NC} $*" >&2; }
die()   { error "$@"; exit 1; }

# ============================================================================
# Pre-flight checks
# ============================================================================

preflight() {
  local missing=()
  for cmd in docker helm kubectl; do
    if ! command -v "$cmd" &>/dev/null; then
      missing+=("$cmd")
    fi
  done
  if [[ ${#missing[@]} -gt 0 ]]; then
    die "Missing required tools: ${missing[*]}"
  fi

  if ! docker info &>/dev/null; then
    die "Docker daemon is not running"
  fi

  if [[ ! -f "$VALUES_FILE" ]]; then
    die "E2E values file not found: $VALUES_FILE"
  fi
}

# ============================================================================
# Image loading via SSH into K3s VM containerd
# ============================================================================

load_image_to_vm() {
  local image="$1"
  info "Loading $image into K3s VM..."
  docker save "$image" | ssh $SSH_OPTS root@localhost k3s ctr images import -
}

# ============================================================================
# up
# ============================================================================

cmd_up() {
  local skip_build=false
  for arg in "$@"; do
    case "$arg" in
      --skip-build) skip_build=true ;;
    esac
  done

  preflight

  # 1. Start bare K3s VM (cluster + kubeconfig + CRDs)
  info "Starting K3s VM..."
  "$SCRIPT_DIR/k3s-vm"
  ok "K3s VM ready"

  export KUBECONFIG="$KUBECONFIG_FILE"

  # 2. Build images
  if [[ "$skip_build" == "true" ]]; then
    info "Skipping image build (--skip-build)"
  else
    info "Building operator and web images..."
    docker buildx bake --load --file "$PROJECT_ROOT/docker-compose.build.yml" operator-production web-production
    ok "Images built"
  fi

  # 3. Load images into VM containerd via SSH
  load_image_to_vm "$OPERATOR_IMAGE"
  load_image_to_vm "$WEB_IMAGE"
  ok "Images loaded into K3s VM"

  # 4. Build Helm dependencies
  info "Building Helm chart dependencies..."
  helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx 2>/dev/null || true
  helm repo add cloudnative-pg https://cloudnative-pg.github.io/charts 2>/dev/null || true
  helm repo update
  helm dependency build "$PROJECT_ROOT/charts/catalyst"
  ok "Helm dependencies ready"

  # 5. Helm install
  local helm_extra_args=()
  if [[ -n "${GITHUB_PAT:-}" ]]; then
    helm_extra_args+=(--set "web.env[6].name=GITHUB_PAT" --set "web.env[6].value=$GITHUB_PAT")
    info "GITHUB_PAT set from environment"
  fi

  info "Installing/upgrading Catalyst via Helm..."
  helm upgrade --install catalyst "$PROJECT_ROOT/charts/catalyst" \
    --namespace "$NAMESPACE" \
    --create-namespace \
    --values "$VALUES_FILE" \
    --set operator.localPreviewRouting=true \
    --set "operator.ingressPort=$HOST_PORT" \
    --set operator.ingressNamespace="$NAMESPACE" \
    --set ingress-nginx.controller.hostPort.enabled=false \
    --set ingress-nginx.controller.service.type=NodePort \
    --set ingress-nginx.controller.service.nodePorts.http=30080 \
    "${helm_extra_args[@]}" \
    --wait \
    --timeout 10m
  ok "Catalyst deployed via Helm"

  # 6. Wait for services
  info "Waiting for CloudNativePG operator..."
  kubectl wait --for=condition=available deployment/catalyst-cloudnative-pg -n "$NAMESPACE" --timeout=120s

  info "Waiting for PostgreSQL cluster..."
  kubectl wait --for=condition=Ready cluster/catalyst-db -n "$NAMESPACE" --timeout=300s

  info "Waiting for Catalyst operator..."
  kubectl wait --for=condition=available deployment/catalyst-operator -n "$NAMESPACE" --timeout=120s

  info "Waiting for Catalyst web..."
  kubectl wait --for=condition=available deployment/catalyst-web -n "$NAMESPACE" --timeout=300s

  info "Waiting for ingress controller..."
  kubectl wait --for=condition=available deployment/catalyst-ingress-nginx-controller -n "$NAMESPACE" --timeout=120s

  ok "All services running"
  kubectl get pods -n "$NAMESPACE"

  # 7. Install npm dependencies (needed for seed and tests)
  info "Installing npm dependencies..."
  (cd "$PROJECT_ROOT/web" && npm ci)

  # 8. Seed database
  info "Seeding database..."
  kubectl exec deployment/catalyst-web -n "$NAMESPACE" -- node seed.cjs
  ok "Database seeded"

  # 9. Port-forward
  _start_port_forward

  # 10. Health check
  info "Waiting for health check..."
  local ok_health=false
  for i in $(seq 1 30); do
    if curl -sf http://localhost:3000/api/health/readiness > /dev/null 2>&1; then
      ok_health=true
      break
    fi
    echo "  Attempt $i/30..."
    sleep 2
  done

  if [[ "$ok_health" != "true" ]]; then
    error "Cannot reach web service after 60 seconds"
    kubectl logs deployment/catalyst-web -n "$NAMESPACE" --tail=50 || true
    die "Health check failed"
  fi

  ok "Health check passed"

  # Summary
  echo ""
  echo "=============================================="
  echo " E2E Cluster Ready (K3s VM + Helm)"
  echo "=============================================="
  echo ""
  echo "  Web:        http://localhost:3000"
  echo "  Ingress:    http://localhost:$HOST_PORT"
  echo "  Kubeconfig: $KUBECONFIG_FILE"
  echo "  Namespace:  $NAMESPACE"
  echo ""
  echo "  Run tests:  bin/e2e-cluster test"
  echo "  Tear down:  bin/e2e-cluster down"
  echo "  Full reset: bin/k3s-vm reset"
  echo ""
}

_start_port_forward() {
  _stop_port_forward 2>/dev/null || true

  info "Starting port-forward to web service..."
  export KUBECONFIG="$KUBECONFIG_FILE"
  kubectl port-forward svc/catalyst-web -n "$NAMESPACE" 3000:3000 &
  local pf_pid=$!
  mkdir -p "$(dirname "$PF_PID_FILE")"
  echo "$pf_pid" > "$PF_PID_FILE"
  info "Port-forward PID: $pf_pid"
}

_stop_port_forward() {
  if [[ -f "$PF_PID_FILE" ]]; then
    local pid
    pid=$(cat "$PF_PID_FILE")
    if kill -0 "$pid" 2>/dev/null; then
      kill "$pid" 2>/dev/null || true
    fi
    rm -f "$PF_PID_FILE"
  fi
  # Also kill any stray port-forward processes for our service
  pkill -f "kubectl port-forward svc/catalyst-web" 2>/dev/null || true
}

# ============================================================================
# down
# ============================================================================

cmd_down() {
  info "Tearing down E2E deployment (VM preserved)..."

  _stop_port_forward

  export KUBECONFIG="$KUBECONFIG_FILE"

  if helm list -n "$NAMESPACE" -q 2>/dev/null | grep -q "^catalyst$"; then
    helm uninstall catalyst -n "$NAMESPACE"
    ok "Helm release 'catalyst' uninstalled"
  else
    info "Helm release 'catalyst' not found (already uninstalled?)"
  fi

  # Clean up namespace
  kubectl delete namespace "$NAMESPACE" --ignore-not-found=true 2>/dev/null || true

  ok "Cleanup complete (VM still running â€” use 'bin/k3s-vm stop' to stop it)"
}

# ============================================================================
# test
# ============================================================================

cmd_test() {
  export KUBECONFIG="$KUBECONFIG_FILE"

  # Check that Helm release exists
  if ! helm list -n "$NAMESPACE" -q 2>/dev/null | grep -q "^catalyst$"; then
    die "E2E deployment not found. Run 'bin/e2e-cluster up' first."
  fi

  # Ensure port-forward is running
  if [[ -f "$PF_PID_FILE" ]]; then
    local pid
    pid=$(cat "$PF_PID_FILE")
    if ! kill -0 "$pid" 2>/dev/null; then
      warn "Port-forward not running, restarting..."
      _start_port_forward
      sleep 3
    fi
  else
    warn "Port-forward not running, starting..."
    _start_port_forward
    sleep 3
  fi

  # Build KUBECONFIG_PRIMARY (base64-encoded JSON kubeconfig)
  local kubeconfig_primary
  kubeconfig_primary=$(kubectl config view --raw -o json | base64 -w 0)

  # Default to the K8s deployment test; pass extra args to override
  local test_target="${*:-__tests__/e2e/deployment-environment.spec.ts}"

  info "Running Playwright E2E tests: $test_target"
  (
    cd "$PROJECT_ROOT/web"
    CI=true \
    PLAYWRIGHT_BASE_URL=http://localhost:3000 \
    KUBECONFIG_PRIMARY="$kubeconfig_primary" \
    LOCAL_PREVIEW_ROUTING=true \
    INGRESS_PORT="$HOST_PORT" \
    npx playwright test $test_target
  )
}

# ============================================================================
# status
# ============================================================================

cmd_status() {
  export KUBECONFIG="$KUBECONFIG_FILE"

  if ! helm list -n "$NAMESPACE" -q 2>/dev/null | grep -q "^catalyst$"; then
    echo "E2E deployment: not running"
    echo "Run 'bin/e2e-cluster up' to deploy."
    return
  fi

  echo "E2E deployment: active (Helm release 'catalyst')"
  echo ""
  kubectl get pods -n "$NAMESPACE" -o wide
  echo ""
  kubectl get svc -n "$NAMESPACE"

  if [[ -f "$PF_PID_FILE" ]]; then
    local pid
    pid=$(cat "$PF_PID_FILE")
    if kill -0 "$pid" 2>/dev/null; then
      echo ""
      echo "Port-forward: active (PID: $pid) -> http://localhost:3000"
    else
      echo ""
      echo "Port-forward: dead (stale PID file)"
    fi
  else
    echo ""
    echo "Port-forward: not running"
  fi
}

# ============================================================================
# logs
# ============================================================================

cmd_logs() {
  export KUBECONFIG="$KUBECONFIG_FILE"

  if ! helm list -n "$NAMESPACE" -q 2>/dev/null | grep -q "^catalyst$"; then
    die "E2E deployment not running."
  fi

  local target="${1:-all}"

  case "$target" in
    web)
      kubectl logs -f deployment/catalyst-web -n "$NAMESPACE" --all-containers=true
      ;;
    operator)
      kubectl logs -f -n "$NAMESPACE" -l control-plane=controller-manager --all-containers=true
      ;;
    all|*)
      info "Tailing web and operator logs (Ctrl+C to stop)..."
      kubectl logs -f deployment/catalyst-web -n "$NAMESPACE" --all-containers=true --prefix=true &
      kubectl logs -f -n "$NAMESPACE" -l control-plane=controller-manager --all-containers=true --prefix=true &
      wait
      ;;
  esac
}

# ============================================================================
# Main
# ============================================================================

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    up)     cmd_up "$@" ;;
    down)   cmd_down "$@" ;;
    test)   cmd_test "$@" ;;
    status) cmd_status "$@" ;;
    logs)   cmd_logs "$@" ;;
    help|--help|-h)
      echo "Usage: bin/e2e-cluster <command> [options]"
      echo ""
      echo "Commands:"
      echo "  up [--skip-build]   Start K3s VM, build images, deploy via Helm, seed"
      echo "  down                Helm uninstall + cleanup (VM preserved)"
      echo "  test [-- args]      Run Playwright E2E tests"
      echo "  status              Show deployment and pod status"
      echo "  logs [web|operator] Tail pod logs (default: all)"
      echo ""
      echo "Environment:"
      echo "  GITHUB_PAT          GitHub token (optional, passed to web pod)"
      ;;
    *)
      die "Unknown command: $cmd. Run 'bin/e2e-cluster help' for usage."
      ;;
  esac
}

main "$@"
