#!/bin/bash
set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}=== Catalyst Environment Validator ===${NC}"

# 1. Check Dependencies
echo -e "${GREEN}--> Checking prerequisites...${NC}"
command -v kubectl >/dev/null 2>&1 || { echo >&2 "kubectl is required but not installed. Aborting."; exit 1; }

CURRENT_CONTEXT=$(kubectl config current-context)
echo "Current Kubernetes Context: $CURRENT_CONTEXT"

# Skip confirmation in CI
if [ "$CI" != "true" ]; then
    read -p "Are you sure you want to run validation against this cluster? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]
    then
        echo "Aborting."
        exit 1
    fi
fi

# 2. Deploy Operator (Skip if environments are specified, assuming pre-deployed)
ENV_NAMES=("$@")
if [ ${#ENV_NAMES[@]} -eq 0 ]; then
    echo -e "${GREEN}--> Deploying Operator...${NC}"
    cd operator
    make deploy
    cd ..

    echo -e "${GREEN}--> Applying Zero-Config Examples...${NC}"
    kubectl apply -f operator/examples/zero-config.nextjs-libsql.yaml
    kubectl apply -f operator/examples/zero-config.rails-postgres.yaml
    
    ENV_NAMES=("nextjs-pr-123" "rails-pr-456")
fi

# 4. Wait for Readiness
echo -e "${GREEN}--> Waiting for Environments to become Ready...${NC}"
# Timeout: 10 minutes (600s)
TIMEOUT=600
START_TIME=$(date +%s)

wait_for_env() {
    local env_name=$1
    local namespace=${2:-"ci-team"}  # Default to ci-team for CI tests
    echo "Waiting for $env_name in namespace $namespace..."
    
    while true; do
        CURRENT_TIME=$(date +%s)
        ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
        if [ $ELAPSED_TIME -ge $TIMEOUT ]; then
            echo -e "${RED}Timeout waiting for $env_name${NC}"
            return 1
        fi

        PHASE=$(kubectl get environment $env_name -n $namespace -o jsonpath='{.status.phase}' 2>/dev/null || echo "NotFound")
        
        if [ "$PHASE" == "Ready" ]; then
            echo -e "${GREEN}$env_name is Ready!${NC}"
            return 0
        elif [ "$PHASE" == "Failed" ]; then
            echo -e "${RED}$env_name Failed!${NC}"
            kubectl get environment $env_name -n $namespace -o yaml
            return 1
        else
            echo -ne "Status: $PHASE (${ELAPSED_TIME}s/${TIMEOUT}s)\r"
            sleep 5
        fi
    done
}

# Wait for environments
for env in "${ENV_NAMES[@]}"; do
    wait_for_env "$env" || exit 1
done

echo -e "${GREEN}=== Validation Complete: All Environments Ready ===${NC}"
kubectl get environments -A
