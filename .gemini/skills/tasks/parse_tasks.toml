# tasks:parse_tasks
#
# Extract and display tasks from the detected source
#
# Generated by DeepWork - do not edit manually

description = "Extract and display tasks from the detected source"

prompt = """
# tasks:parse_tasks

**Step 2/8** in **tasks** workflow

> Execute implementation tasks from specs, PRs, or branches to completion

## Prerequisites (Verify First)

Before proceeding, confirm these steps are complete:
- `/tasks:detect_source`

## Instructions

**Goal**: Extract and display tasks from the detected source

# Parse Tasks

## Objective

Extract and display all tasks from the detected source, normalizing them into a consistent format regardless of whether they came from a spec file, PR, or branch.

## Task

Read the source context and parse tasks into a structured list that can be used for selection and execution.

### Process

1. **Read source context**
   - Load `tasks/source_context.json` from the previous step
   - Determine parsing strategy based on `source_type`

2. **Parse tasks based on source type**

   **For spec (tasks.md)**:
   - Look for checkbox items: `- [ ]` (incomplete) and `- [x]` (complete)
   - Extract task text and any sub-tasks
   - Preserve hierarchy (parent tasks with children)
   - Parse any metadata (estimates, priorities, labels)

   ```markdown
   - [ ] Implement user authentication
     - [ ] Add login form
     - [ ] Add session management
   - [x] Set up database schema
   ```

   **For PR**:
   - Fetch PR body using: `gh pr view <number> --json body`
   - Look for task lists in the PR description
   - Also check linked issues: `gh pr view <number> --json body,commits`
   - Parse checkbox items from the body

   **For branch**:
   - Look for TODO comments in changed files
   - Check for a tasks.md in the branch
   - Analyze commit messages for implied tasks
   - List uncommitted changes as potential tasks

3. **Normalize task format**
   - Assign unique IDs to each task
   - Determine completion status
   - Extract dependencies between tasks
   - Calculate task order based on dependencies

4. **Display tasks to user**
   - Show a numbered list of tasks
   - Indicate completion status
   - Show any dependencies or blocking relationships

## Output Format

### tasks/parsed_tasks.json

A JSON file containing all parsed tasks in normalized format.

**Structure**:

```json
{
  "source_type": "spec",
  "source_ref": "tasks.md",
  "parsed_at": "2024-01-15T10:35:00Z",
  "summary": {
    "total": 8,
    "completed": 2,
    "pending": 6
  },
  "tasks": [
    {
      "id": "task-1",
      "title": "Implement user authentication",
      "description": "Add login/logout functionality with session management",
      "status": "pending",
      "parent_id": null,
      "children": ["task-1a", "task-1b"],
      "depends_on": [],
      "blocked_by": [],
      "metadata": {
        "priority": "high",
        "estimate": "2h",
        "labels": ["auth", "backend"]
      },
      "source_location": {
        "file": "tasks.md",
        "line": 15
      }
    },
    {
      "id": "task-1a",
      "title": "Add login form",
      "description": null,
      "status": "pending",
      "parent_id": "task-1",
      "children": [],
      "depends_on": [],
      "blocked_by": [],
      "metadata": {},
      "source_location": {
        "file": "tasks.md",
        "line": 16
      }
    }
  ]
}
```

**Example display output** (shown to user):

```
## Tasks from tasks.md

| # | Status | Task | Dependencies |
|---|--------|------|--------------|
| 1 | ⬜ | Implement user authentication | - |
|   | ⬜ | └─ Add login form | - |
|   | ⬜ | └─ Add session management | task-1a |
| 2 | ✅ | Set up database schema | - |
| 3 | ⬜ | Add API endpoints | task-2 |
| 4 | ⬜ | Write integration tests | task-1, task-3 |

**Summary**: 6 pending, 2 completed (8 total)
```

## Quality Criteria

- All tasks from the source are captured
- Task IDs are unique and stable
- Completion status is accurately detected
- Dependencies are correctly identified
- Hierarchical relationships (parent/child) are preserved
- Output displays clearly to the user
- JSON output is valid and complete
- When all criteria are met, include `<promise>✓ Quality Criteria Met</promise>` in your response

## Context

This step transforms raw task data into a structured format that enables smart task selection and tracking. The normalized format allows the workflow to handle tasks consistently regardless of their original source, making it easy to track progress and manage dependencies.


### Job Context

A comprehensive workflow for driving implementation tasks to completion. Takes tasks
from multiple sources (tasks.md specs, PR descriptions, or branch context) and
executes them one at a time through the full development cycle.

The workflow:
1. Detects or accepts explicit task source (branch, PR, or spec file)
2. Parses and displays available tasks
3. Selects a task (smart selection or user-specified)
4. Implements the code changes
5. Validates locally (tests + typecheck)
6. Commits changes and marks task complete
7. Monitors CI for success
8. Debugs failures by fetching logs and E2E screenshots

Key features:
- Supports tasks.md, PR descriptions, and GitHub issues as task sources
- One task at a time execution for careful review
- Full CI validation with smart log extraction
- Auto-downloads E2E failure screenshots for debugging
- In-place task tracking (updates source directly)

Target users: Developers working with spec-driven or PR-based task workflows.


## Required Inputs


**Files from Previous Steps** - Read these first:
- `tasks/source_context.json` (from `detect_source`)

## Work Branch

Use branch format: `deepwork/tasks-[instance]-YYYYMMDD`

- If on a matching work branch: continue using it
- If on main/master: create new branch with `git checkout -b deepwork/tasks-[instance]-$(date +%Y%m%d)`

## Outputs

**Required outputs**:
- `tasks/parsed_tasks.json`

## On Completion

1. Verify outputs are created
2. Inform user: "Step 2/8 complete, outputs: tasks/parsed_tasks.json"
3. **Tell user next command**: `/tasks:select_task`

---

**Reference files**: `.deepwork/jobs/tasks/job.yml`, `.deepwork/jobs/tasks/steps/parse_tasks.md`
"""