name: Operator Integration Tests (North Star)

on:
  pull_request:
    paths:
      - 'operator/**'
      - '.github/workflows/test.operator.integration.yml'
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Create Kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: catalyst-test
          wait: 60s

      - name: Install In-Cluster Registry
        run: |
          # Deploy Registry in default namespace
          kubectl run registry --image=registry:2 --port=5000
          kubectl expose pod registry --name=registry --port=5000 --type=ClusterIP
          # Wait for registry
          kubectl wait --for=condition=ready pod/registry --timeout=120s
          
          # Verify connectivity using internal DNS
          kubectl run curl --rm -i --image=curlimages/curl --restart=Never -- curl -v http://registry.default.svc.cluster.local:5000/v2/

      - name: Install Cert Manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml
          kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=120s
          # Create fake ClusterIssuer
          cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            selfSigned: {}
          EOF

      - name: Build and Load Operator
        run: |
          cd operator
          make docker-build IMG=catalyst-operator:test
          kind load docker-image catalyst-operator:test --name catalyst-test

      - name: Deploy Operator
        run: |
          cd operator
          make deploy IMG=catalyst-operator:test

      - name: Prepare Test Data
        run: |
          # Create dummy git secret
          kubectl create secret generic github-pat-secret \
            --from-literal=token=dummy-token \
            --namespace=default

          # Create Valid CI Test Manifest
          # Uses the repo itself to deploy 'charts/example'
          cat <<EOF > operator/examples/ci-valid.yaml
          apiVersion: catalyst.catalyst.dev/v1alpha1
          kind: Project
          metadata:
            name: ci-project
            namespace: default
          spec:
            sources:
              - name: catalyst
                repositoryUrl: https://github.com/ncrmro/catalyst
                branch: main
          
            templates:
              ci-test:
                type: helm
                path: charts/example
                sourceRef: catalyst
          
          ---
          apiVersion: catalyst.catalyst.dev/v1alpha1
          kind: Environment
          metadata:
            name: ci-env
            namespace: default
          spec:
            projectRef:
              name: ci-project
            type: ci-test
            sources:
              - name: catalyst
                branch: main
                commitSha: "latest"
          EOF

      - name: Run Validation
        run: |
          kubectl apply -f operator/examples/ci-valid.yaml
          ./bin/validate-envs ci-env

      - name: Debug on Failure
        if: failure()
        run: |
          echo "=== All Resources ==="
          kubectl get all -A
          
          echo "=== Events ==="
          kubectl get events -A --sort-by=.metadata.creationTimestamp
          
          echo "=== Operator Logs ==="
          kubectl logs -n catalyst-system -l control-plane=controller-manager --tail=-1
          
          echo "=== Environment Logs ==="
          # Dump logs from any pod in the default namespace (where envs are created)
          kubectl logs -n default --all-containers=true --tail=-1 --prefix=true || true
          
          echo "=== Describe Pods ==="
          kubectl describe pods -A
