# Data Model: Agent Harness

**Feature**: Agent Harness for Spec-Driven Development
**Branch**: `006-agent-harness`
**Date**: 2026-01-11

## Overview

This document defines all data entities, their schemas, relationships, and validation rules for the Agent Harness system. All entities are stored as git-tracked YAML/JSONL files within the spec folder structure.

---

## Entity Diagram

```
┌─────────────────┐
│  Configuration  │ (1) ─────────────┐
└─────────────────┘                  │
                                     │
┌─────────────────┐                  │
│   Spec Folder   │ (1) ────┐       │
└─────────────────┘          │       │
        │                    │       │
        │ contains (n)       │       │
        ▼                    ▼       ▼
┌─────────────────┐    ┌──────────────────┐
│   Worktree      │    │  Progress State  │
└─────────────────┘    └──────────────────┘
        │                       │
        │ references (n)        │ tracks (n)
        ▼                       ▼
┌─────────────────┐    ┌──────────────────┐
│   Sub-Branch    │    │   Task Status    │
└─────────────────┘    └──────────────────┘
        │                       │
        │ maps to (1)           │
        ▼                       ▼
┌─────────────────┐    ┌──────────────────┐
│  Pull Request   │    │ Operation Journal│
└─────────────────┘    └──────────────────┘
```

---

## 1. Configuration

**File**: `.agent-harness.yml` (repository root)
**Format**: YAML
**Tracked**: Yes (git-tracked, checked into repo)

### Schema

```yaml
version: integer # Config schema version (currently 1)

branches:
  specPrefix: string # Prefix for spec directories (e.g., "specs/")
  specPattern: string # Pattern for spec branches: "{number}-{slug}"
  subPattern: string # Pattern for sub-branches: "{number}-{slug}/{description}"
  mainBranch: string # Name of main branch (e.g., "main", "master")

worktrees:
  basePath: string # Base directory for worktrees (e.g., "./worktree")
  namePattern: string # Worktree directory naming pattern

agents:
  default: string # Default agent CLI (claude|gemini|codex|aider)
  claudePath: string # Path to claude binary (default: "claude")
  geminiPath: string # Path to gemini binary
  codexPath: string # Path to codex binary
  aiderPath: string # Path to aider binary

vcs:
  provider: string # VCS provider (github|gitlab)
  token: string # API token (supports ${ENV_VAR} expansion)
  apiUrl: string # Optional custom API URL

catalyst:
  enabled: boolean # Enable Catalyst platform sync
  syncInterval: duration # How often to sync (e.g., "5m")
```

### Validation Rules

- `version` must be `1`
- `branches.specPattern` must contain `{number}` and `{slug}` placeholders
- `branches.subPattern` must contain `{number}`, `{slug}`, and `{description}`
- `agents.default` must be one of: `claude`, `gemini`, `codex`, `aider`
- `vcs.provider` must be one of: `github`, `gitlab`
- `vcs.token` required for VCS API operations
- `catalyst.syncInterval` must be valid Go duration string (e.g., "5m", "1h")

### Example

```yaml
version: 1

branches:
  specPrefix: "specs/"
  specPattern: "{number}-{slug}"
  subPattern: "{number}-{slug}/{description}"
  mainBranch: "main"

worktrees:
  basePath: "./worktree"
  namePattern: "{number}-{slug}-{description}"

agents:
  default: "claude"
  claudePath: "claude"
  geminiPath: "gemini"

vcs:
  provider: "github"
  token: "${GITHUB_TOKEN}"

catalyst:
  enabled: true
  syncInterval: "5m"
```

---

## 2. Spec Folder

**Location**: `specs/{number}-{slug}/`
**Format**: Directory with multiple files
**Tracked**: Yes (entire directory git-tracked)

### Directory Structure

```
specs/006-agent-harness/
├── spec.md              # Feature specification (user stories, requirements)
├── plan.md              # Implementation plan (technical approach)
├── tasks.md             # Task breakdown (generated by /speckit.tasks)
├── research.md          # Technology research (generated by /speckit.plan)
├── data-model.md        # This file
├── quickstart.md        # Developer onboarding guide
├── contracts/           # API contracts directory
│   ├── acp-protocol.md  # ACP integration contract
│   └── vcs-provider.go  # VCS provider interface
└── .progress/           # Progress tracking (git-tracked)
    ├── state.yaml       # Current state
    └── operations.jsonl # Operation journal
```

### Metadata (Derived)

- **Spec Number**: Extracted from directory name (e.g., `006`)
- **Spec Slug**: Extracted from directory name (e.g., `agent-harness`)
- **Spec Branch**: `{number}-{slug}` (e.g., `006-agent-harness`)

---

## 3. Progress State

**File**: `specs/{number}-{slug}/.progress/state.yaml`
**Format**: YAML
**Tracked**: Yes (git-tracked for cross-machine sync)

### Schema

```yaml
version: integer # Schema version (currently 1)
spec: string # Spec identifier (e.g., "006-agent-harness")
lastActive: timestamp # ISO 8601 timestamp of last activity
lastCommit: string # Git SHA of last commit on spec branch

tasks: # Array of task statuses
  - id: string # Task ID (e.g., "T001")
    title: string # Human-readable task description
    status: enum # pending|in_progress|completed|blocked
    assignedTo: string? # Optional: who/what is working on it
    startedAt: timestamp? # When task entered in_progress
    completedAt: timestamp?# When task completed
    blockedReason: string? # If blocked, why

worktrees: # Array of active worktrees
  - path: string # Absolute path to worktree
    branch: string # Branch name (e.g., "006-agent-harness/add-acp")
    createdAt: timestamp # When worktree was created
    lastAccessed: timestamp# Last time worktree was used
    devServerPort: integer?# Assigned dev server port (if applicable)

pullRequests: # Array of tracked PRs
  - number: integer # PR number from VCS
    url: string # Full URL to PR
    title: string # PR title
    branch: string # Source branch
    baseBranch: string # Target branch
    status: enum # open|merged|closed
    dependsOn: integer[] # Array of PR numbers this depends on
```

### Validation Rules

- `version` must be `1`
- `spec` must match parent directory name
- `lastActive` must be valid ISO 8601 timestamp
- `tasks[].status` must be one of: `pending`, `in_progress`, `completed`, `blocked`
- `tasks[].id` must be unique within spec
- `worktrees[].path` must be absolute path
- `worktrees[].branch` must follow `subPattern` from config
- `pullRequests[].status` must be one of: `open`, `merged`, `closed`
- `pullRequests[].dependsOn` must reference valid PR numbers

### State Transitions

**Task Status Flow**:

```
pending → in_progress → completed
               ↓
           blocked → in_progress
```

**PR Status Flow**:

```
open → merged
  ↓
closed
```

### Example

```yaml
version: 1
spec: 006-agent-harness
lastActive: 2026-01-11T14:32:00Z
lastCommit: abc123def456

tasks:
  - id: T001
    title: "Implement spec branch creation"
    status: completed
    startedAt: 2026-01-11T09:00:00Z
    completedAt: 2026-01-11T10:30:00Z

  - id: T002
    title: "Add ACP client library"
    status: in_progress
    startedAt: 2026-01-11T11:00:00Z

  - id: T003
    title: "Build PR chain manager"
    status: pending

worktrees:
  - path: /home/user/project/worktree/006-agent-harness-add-acp
    branch: 006-agent-harness/add-acp
    createdAt: 2026-01-11T11:00:00Z
    lastAccessed: 2026-01-11T14:32:00Z
    devServerPort: 43217

pullRequests:
  - number: 123
    url: https://github.com/org/repo/pull/123
    title: "feat(agent-harness): add ACP client"
    branch: 006-agent-harness/add-acp
    baseBranch: main
    status: open
    dependsOn: []
```

---

## 4. Operation Journal

**File**: `specs/{number}-{slug}/.progress/operations.jsonl`
**Format**: JSON Lines (newline-delimited JSON)
**Tracked**: Yes (git-tracked for audit trail)

### Schema (per line)

```json
{
  "id": "string", // Unique operation ID (e.g., "op-001-worktree")
  "type": "enum", // Operation type (see types below)
  "state": "enum", // pending|in_progress|completed|failed|rolled_back
  "startedAt": "timestamp", // ISO 8601 start time
  "completedAt": "timestamp?", // ISO 8601 completion time (if completed/failed)
  "data": {}, // Operation-specific payload
  "error": "string?" // Error message if failed
}
```

### Operation Types

| Type              | Description               | Data Schema                       |
| ----------------- | ------------------------- | --------------------------------- |
| `worktree_create` | Create new worktree       | `{branch, path, fromRemote}`      |
| `worktree_delete` | Remove worktree           | `{path, force}`                   |
| `branch_create`   | Create spec/sub-branch    | `{branch, from}`                  |
| `pr_chain_init`   | Initialize PR chain       | `{branches[], baseRef}`           |
| `pr_create`       | Create single PR          | `{branch, base, title, draft}`    |
| `pr_update_base`  | Update PR base branch     | `{prNumber, newBase}`             |
| `context_inject`  | Inject context into agent | `{agent, specPath, commits, prs}` |

### State Machine

```
pending → in_progress → completed
               ↓
           failed → rolled_back (optional)
```

### Validation Rules

- `id` must be unique across all operations
- `type` must be one of the defined operation types
- `state` must be one of: `pending`, `in_progress`, `completed`, `failed`, `rolled_back`
- `startedAt` required for all states except `pending`
- `completedAt` required for `completed`, `failed`, `rolled_back` states
- `error` required for `failed` state
- `data` schema must match operation type

### Example

```jsonl
{"id":"op-001","type":"worktree_create","state":"completed","startedAt":"2026-01-11T11:00:00Z","completedAt":"2026-01-11T11:00:05Z","data":{"branch":"006-agent-harness/add-acp","path":"/home/user/project/worktree/006-agent-harness-add-acp","fromRemote":false}}
{"id":"op-002","type":"pr_chain_init","state":"in_progress","startedAt":"2026-01-11T12:00:00Z","data":{"branches":["006-agent-harness/01-foundation","006-agent-harness/02-implementation"],"baseRef":"main"}}
{"id":"op-003","type":"context_inject","state":"failed","startedAt":"2026-01-11T13:00:00Z","completedAt":"2026-01-11T13:00:03Z","data":{"agent":"claude","specPath":"specs/006-agent-harness"},"error":"agent process not found in PATH"}
```

---

## 5. Worktree

**Representation**: Directory + `.env` file
**Location**: `{worktrees.basePath}/{namePattern}/`
**Tracked**: No (worktrees are ephemeral, `.env` is git-ignored)

### Metadata (in Progress State)

- **path**: Absolute filesystem path
- **branch**: Git branch checked out in worktree
- **createdAt**: Creation timestamp
- **lastAccessed**: Last activity timestamp
- **devServerPort**: Assigned port (if dev server running)

### `.env` File Schema

```bash
# Auto-generated by agent-harness
DEV_SERVER_PORT=43217
SPEC_BRANCH=006-agent-harness
SUB_BRANCH=006-agent-harness/add-acp
WORKTREE_CREATED_AT=2026-01-11T11:00:00Z
```

### Validation Rules

- Path must be absolute
- Branch must exist in repository
- Port must be between 1024-65535
- Worktree directory must have valid git worktree metadata (`.git` file pointing to main repo)

---

## 6. Sub-Branch

**Representation**: Git branch
**Naming**: Follows `{number}-{slug}/{description}` pattern
**Tracked**: Yes (git branch)

### Derived Metadata

- **Spec Number**: Extracted from branch name (e.g., `006`)
- **Spec Slug**: Extracted from branch name (e.g., `agent-harness`)
- **Description**: Extracted from branch name (e.g., `add-acp`)
- **Parent Spec**: `{number}-{slug}` (e.g., `006-agent-harness`)

### Validation Rules

- Must follow configured `subPattern`
- Parent spec branch must exist
- Description must be URL-safe (lowercase, hyphens only)

---

## 7. Pull Request

**Representation**: External VCS resource (GitHub/GitLab)
**Tracked**: References stored in Progress State

### Schema (in Progress State)

```yaml
number: integer # PR number from VCS
url: string # Full URL to PR
title: string # PR title
branch: string # Source branch (sub-branch)
baseBranch: string # Target branch (usually main or another sub-branch)
status: enum # open|merged|closed
dependsOn: integer[] # Array of PR numbers this PR depends on (for PR chains)
```

### Validation Rules

- `number` must be positive integer
- `url` must be valid HTTP(S) URL
- `branch` must follow `subPattern`
- `baseBranch` must exist in repository
- `status` must be one of: `open`, `merged`, `closed`
- `dependsOn` PRs must exist and reference valid PR numbers

### PR Chain Dependency Rules

- PR2 in chain must have `dependsOn: [PR1]`
- Cannot have circular dependencies
- Base branch update propagates through chain when dependency merges

---

## 8. Agent Context (Ephemeral)

**Representation**: In-memory structure passed via ACP
**Tracked**: No (generated on-demand from other entities)

### Schema

```go
type AgentContext struct {
    Spec struct {
        Number      int       // e.g., 6
        Slug        string    // e.g., "agent-harness"
        Content     string    // Full spec.md content
        Tasks       []Task    // From tasks.md
        Plan        string    // plan.md content (if exists)
    }

    Git struct {
        Branch      string    // Current branch
        RecentCommits []Commit // Last 10 commits
        Status      string    // git status output
    }

    VCS struct {
        OpenPRs     []PullRequest // Open PRs for this spec
        Comments    []Comment     // Recent PR comments
    }

    Progress struct {
        CurrentState ProgressState  // From state.yaml
        PendingOps   []Operation    // In-progress operations
    }
}
```

### Generation Logic

1. Read spec folder files (spec.md, tasks.md, plan.md)
2. Execute `git log -10` for recent commits
3. Query VCS API for open PRs matching spec branch pattern
4. Load progress state from `.progress/state.yaml`
5. Load pending operations from `.progress/operations.jsonl`
6. Serialize to JSON for ACP injection

---

## Relationships

### One-to-Many

- **Spec Folder** → **Worktrees**: One spec can have multiple worktrees (one per sub-branch)
- **Spec Folder** → **Sub-Branches**: One spec branch can have multiple sub-branches for PRs
- **Spec Folder** → **Tasks**: One spec tracks multiple tasks in progress state
- **Spec Folder** → **Operations**: One spec has multiple operations in journal

### One-to-One

- **Worktree** → **Sub-Branch**: Each worktree corresponds to exactly one sub-branch
- **Sub-Branch** → **Pull Request**: Each sub-branch maps to at most one PR

### Many-to-Many

- **Pull Requests** → **Pull Requests**: PRs can depend on other PRs (chain dependencies)

---

## Storage Locations

| Entity            | Location                                           | Format     | Git Tracked    |
| ----------------- | -------------------------------------------------- | ---------- | -------------- |
| Configuration     | `.agent-harness.yml`                               | YAML       | Yes            |
| Spec Folder       | `specs/{number}-{slug}/`                           | Directory  | Yes            |
| Progress State    | `specs/{number}-{slug}/.progress/state.yaml`       | YAML       | Yes            |
| Operation Journal | `specs/{number}-{slug}/.progress/operations.jsonl` | JSONL      | Yes            |
| Worktree          | `{worktrees.basePath}/{name}/`                     | Directory  | No             |
| Worktree .env     | `{worktree}/.env`                                  | ENV        | No (ignored)   |
| Sub-Branch        | Git branch                                         | Git        | Yes (branch)   |
| Pull Request      | External VCS                                       | JSON (API) | No (external)  |
| Agent Context     | Memory                                             | Go struct  | No (ephemeral) |

---

## Migration Strategy

### Version 1 (Initial)

- Current schema version
- All entities defined in this document

### Future Versions

Version bumps will be required for:

- Breaking schema changes (e.g., removing fields, changing types)
- New required fields
- Changes to validation rules that affect existing data

Non-breaking additions (new optional fields) can use same version with backward compatibility.

---

## Next Steps

With the data model defined, proceed to:

1. **Contracts**: Define ACP protocol messages and VCS provider interfaces
2. **Quickstart**: Document how developers set up and use the system
3. **Implementation**: Begin coding with clear entity schemas
